#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <math.h>
#include <string.h>	//memcpy
#include "blas.h"
#include "lapack.h"
#include "matrix.h"

const int ione = 1;
const int itwo = 2;
const int ithree = 3;
const int iseven = 7;
const double fone = 1;
const double ftwo = 2;
const double fzero = 0;
const double fmone = -1;
int quiet = 0;

void printmat(double *A, int m, int n);
void fmpcsolve(double *A, double *B, double *At, double *Bt, double *eyen, 
        double *eyem, double *Q, double *R, double *Qf, double *zmax, double *zmin, 
        double *x, double *z, int T, int n, int m, int nz, int niters, double kappa);

void gfgphp(double *Q, double *R, double *Qf, double *zmax, double *zmin, double *z,
        int T, int n, int m, int nz, double *gf, double *gp, double *hp);

void rdrp(double *A, double *B, double *Q, double *R, double *Qf, double *z, double *nu, 
        double *gf, double *gp, double *b, int T, int n, int m, int nz, 
        double kappa, double *rd, double *rp, double *Ctnu);

void resdresp(double *rd, double *rp, int T, int n, int nz, double *resd, 
        double *resp, double *res);
        
void dnudz(double *A, double *B, double *At, double *Bt, double *eyen, 
        double *eyem, double *Q, double *R, double *Qf, double *hp, double *rd, 
        double *rp, int T, int n, int m, int nz, double kappa, double *dnu, double *dz);
        
//void mexFunction(int nlhs, mxArray *plhs[], int nrhs, const mxArray *prhs[])
int main()
{
    /* problem setup */
    int i, j, k, m, n, nz, T, niters, nn, nm, mm, nt, mt, nsteps;
    double kappa;
    double *dptr, *dptr1, *dptr2;
    double *At, *Bt, *x;
    double *zmax, *zmin, *zmaxp, *zminp, *z, *eyen, *eyem;
	double telapsed;
    clock_t t1, t2;
    /* double *A, *B, *Q, *R, *Qf, *xmax, *xmin, *umax, *umin;
    double *X, *U, *x0;
    double *X0, *U0; */
    
    n = 12;		/*  state dimension */
	m = 3;
	T = 10;		/*  time horizon */
	nz = T*(n+m);
	nn = n*n;
	mm = m*m;
	nm = n*m;
	nt = n*T;
	mt = m*T;
	nsteps = 100;
	
    double A[n*n], B[n*n], Q[nn], R[m*m], Qf[nn], xmax[n], xmin[n], umax[m], umin[m];
    double X[nt], U[mt], X0[nt], U0[mt], u_[m], x0[n], x_temp[n], x_temp2[n], w_temp[n];
    double Xhist[n*nsteps], Uhist[n*nsteps], Jhist[1*nsteps], thist[1*nsteps];

	static const double dv0[144] = { 0.7627, 0.1149, 0.0025, 0.0, 0.0, 0.0,
	-0.8994, 0.4202, 0.0193, 0.0002, 0.0, 0.0, 0.1149, 0.7652, 0.1149, 0.0025,
	0.0, 0.0, 0.4202, -0.8801, 0.4205, 0.0193, 0.0002, 0.0, 0.0025, 0.1149,
	0.7652, 0.1149, 0.0025, 0.0, 0.0193, 0.4205, -0.8801, 0.4205, 0.0193, 0.0002,
	0.0, 0.0025, 0.1149, 0.7652, 0.1149, 0.0025, 0.0002, 0.0193, 0.4205, -0.8801,
	0.4205, 0.0193, 0.0, 0.0, 0.0025, 0.1149, 0.7652, 0.1149, 0.0, 0.0002,
	0.0193, 0.4205, -0.8801, 0.4202, 0.0, 0.0, 0.0, 0.0025, 0.1149, 0.7627, 0.0,
	0.0, 0.0002, 0.0193, 0.4202, -0.8994, 0.4596, 0.0198, 0.0003, 0.0, 0.0, 0.0,
	0.7627, 0.1149, 0.0025, 0.0, 0.0, 0.0, 0.0198, 0.4599, 0.0198, 0.0003, 0.0,
	0.0, 0.1149, 0.7652, 0.1149, 0.0025, 0.0, 0.0, 0.0003, 0.0198, 0.4599,
	0.0198, 0.0003, 0.0, 0.0025, 0.1149, 0.7652, 0.1149, 0.0025, 0.0, 0.0,
	0.0003, 0.0198, 0.4599, 0.0198, 0.0003, 0.0, 0.0025, 0.1149, 0.7652, 0.1149,
	0.0025, 0.0, 0.0, 0.0003, 0.0198, 0.4599, 0.0198, 0.0, 0.0, 0.0025, 0.1149,
	0.7652, 0.1149, 0.0, 0.0, 0.0, 0.0003, 0.0198, 0.4596, 0.0, 0.0, 0.0, 0.0025,
	0.1149, 0.7627 };

	static const double dv1[36] = { 0.1174, -0.1174, -0.0025, -0.0, -0.0, -0.0,
	0.4398, -0.4401, -0.0196, -0.0002, -0.0, -0.0, 0.0, 0.0025, 0.1199, 0.0,
	-0.1199, -0.0025, 0.0003, 0.0198, 0.4596, 0.0, -0.4596, -0.0198, 0.0, 0.0,
	0.0025, 0.1199, 0.0, -0.1199, 0.0, 0.0003, 0.0198, 0.4596, 0.0, -0.4594 };
	
	const double w[12][100] = {{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000},
								{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000},
								{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000},
								{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000},
								{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000},
								{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000},
								{ -0.04353233, -0.08972979, -0.48472607,  0.18127716, -0.34912702, -0.15802938,  0.19456724, -0.36348126,  0.01551175, -0.03890487,  0.49008259, -0.06007569, -0.04857517, -0.48364507, -0.34639364,  0.36560348, -0.32920719,  0.43423652, -0.06983395, -0.03923017, -0.09992648,  0.12080133,  0.12731479,  0.27640121,  0.06677280,  0.20085723,  0.37345081, -0.14334446, -0.22691184,  0.09717078, -0.33384592, -0.25267237, -0.25404007,  0.00301449,  0.28385902, -0.03919383,  0.31620571, -0.45095317, -0.41892627,  0.02211176, -0.26570027, -0.36905518, -0.23678807,  0.18588997, -0.27284628,  0.13819322,  0.22180028, -0.03384502, -0.07780517, -0.30770858, -0.36413561,  0.18133515, -0.22397034,  0.06762331,  0.10810566, -0.35002832,  0.14120266,  0.37535098,  0.01520790, -0.04543906,  0.04176379, -0.16888921,  0.44251124, -0.28121888, -0.18656502, -0.01441084,  0.31330552, -0.06034632, -0.24157260,  0.43024707, -0.19336714,  0.21290102,  0.45620461, -0.44503079,  0.46845084, -0.18997021,  0.34451594,  0.41708979,  0.14986813,  0.04592416, -0.14198289,  0.13822138,  0.22860019, -0.40596513, -0.44181215, -0.27256419,  0.38647996, -0.24731074, -0.39702348,  0.43322986,  0.42487529, -0.43530740, -0.45171012, -0.04576349,  0.26456716, -0.10256807,  0.25045811,  0.27287548, -0.36872136, -0.00612992},
								{ -0.48149636,  0.39364953,  0.24678568, -0.12051898,  0.19789848, -0.21027410,  0.12131013, -0.48824331, -0.16604852,  0.06782871,  0.28886169,  0.43338011, -0.45610467, -0.30992541,  0.17564465, -0.26764963,  0.49429549, -0.23555083,  0.39032172, -0.04264562, -0.30121148,  0.23127726,  0.19908014, -0.01065452,  0.32300831,  0.46228826,  0.01340071, -0.00169540,  0.12623464, -0.33855125,  0.33315146, -0.14729801,  0.08735822,  0.22197985,  0.48615781, -0.05469295,  0.47709235,  0.25533857,  0.35112240, -0.38293985,  0.43309842, -0.40458698,  0.25363453,  0.17734595,  0.01625200,  0.48656686,  0.15163982,  0.41376324,  0.16042740,  0.21568905,  0.03249823,  0.16582341, -0.13154185,  0.48048127, -0.32400436, -0.11562595, -0.48380252,  0.33525940,  0.10586579,  0.40494922, -0.49314221,  0.00407844,  0.27014853, -0.39451950, -0.26884118,  0.45222323,  0.42382979,  0.20102291, -0.45710187, -0.19005864,  0.22067988,  0.04899644, -0.30377117,  0.09984132, -0.34433202, -0.36521231,  0.37915348, -0.37672131, -0.41499939,  0.34805722,  0.43819943, -0.49977183,  0.45509863, -0.05005355,  0.04218740, -0.17211704,  0.26126076,  0.08488692, -0.34168408, -0.24062003,  0.12949929,  0.04480906, -0.11984800, -0.46143930, -0.12285103,  0.23155079, -0.37380327, -0.20272598,  0.22473389, -0.08245903},
								{  0.32140716, -0.44210870, -0.05490357,  0.33179602, -0.12162700, -0.15880643,  0.29482108,  0.39389797, -0.06709340,  0.29421065, -0.06134147,  0.18333232, -0.47281488,  0.08691847,  0.19921333,  0.30487174, -0.06020914, -0.33969966,  0.23490821, -0.04931112,  0.12520102, -0.30610682, -0.10281605, -0.31409555,  0.17394863,  0.25051823,  0.23265065, -0.06555946,  0.03685169,  0.32947425,  0.33863970, -0.31213952,  0.00605345, -0.19379145, -0.02665729, -0.41225539, -0.27809192,  0.39481276,  0.06204868,  0.26991848, -0.43687210, -0.48513566,  0.15964480,  0.37683002, -0.04179578,  0.00287580,  0.25402267, -0.27142329,  0.17365301, -0.24932722,  0.22578931, -0.36528203, -0.48711369,  0.29183160, -0.49797444, -0.18894144,  0.33685156, -0.16690493,  0.46670263, -0.21784115, -0.04866233,  0.06456859,  0.23740432, -0.35857415, -0.08393617, -0.26807916, -0.30100274,  0.10971499, -0.49411521, -0.23118289,  0.45440651,  0.44134842,  0.27619251, -0.10685401, -0.33704446, -0.27667369, -0.31301047, -0.48655462,  0.26880950,  0.30209766, -0.01233303, -0.16436706,  0.15635111,  0.36915243, -0.04427404,  0.39946879,  0.38376633,  0.02370359, -0.08635014, -0.29582861,  0.37830878,  0.33637560, -0.08720878,  0.06243201,  0.40030622,  0.18463883, -0.45693752, -0.32214564,  0.39951821, -0.20774295},
								{ -0.05529664, -0.14713187,  0.43181458,  0.00281288,  0.36001160,  0.03407902,  0.45684345, -0.30086193, -0.27405013, -0.44081741, -0.00168870, -0.28744014, -0.18731495, -0.44241891,  0.22750913,  0.40839754, -0.15995205,  0.37285526,  0.18732359, -0.08778094,  0.23336280,  0.40481233, -0.08637110,  0.20063541,  0.49944730,  0.23999305, -0.07777341,  0.06245842, -0.44049595,  0.45612241, -0.04838597, -0.00935564, -0.03522108, -0.38783629,  0.40281883, -0.05651678,  0.20368367, -0.21385035, -0.18070370, -0.12494420, -0.23578234, -0.21180665, -0.28593714, -0.48710950,  0.20320334,  0.44770338,  0.16316201,  0.36204490,  0.45733018,  0.43386482, -0.10129695, -0.47750671,  0.38920608, -0.34740638,  0.29022400, -0.33146556,  0.30346219,  0.38070533,  0.32211740, -0.43496565, -0.30433795,  0.26719736,  0.36626227, -0.04303170, -0.20120121, -0.02134161,  0.17427164, -0.20011434,  0.07441797,  0.03645104, -0.36886161, -0.17013522,  0.11329572, -0.28463381, -0.18660263, -0.10345321,  0.49130492, -0.13030928,  0.46970170,  0.16830641, -0.40900964, -0.22490018,  0.24230513, -0.10838278,  0.36308689, -0.18626951, -0.04259374, -0.33658095,  0.06041045, -0.45079156,  0.14167443, -0.35467801, -0.09860870, -0.12768785, -0.31656795,  0.47850302, -0.12906066,  0.19079916, -0.32929869, -0.21033606},
								{  0.11543235,  0.31316650, -0.03400566,  0.20947139,  0.35365513,  0.22711322,  0.02259035, -0.20127699,  0.07980687,  0.10286909, -0.28603667,  0.33923824, -0.48713743, -0.13243196, -0.02161562, -0.26810568, -0.18578269, -0.26211969, -0.15388803,  0.40160982, -0.12411452,  0.06920575,  0.15521295,  0.48270880,  0.46163641, -0.06812661,  0.46137000,  0.11662113, -0.41103824,  0.09554800,  0.45660138, -0.09072567,  0.04141893, -0.05671004, -0.04894124, -0.13370015,  0.02206092, -0.24879945, -0.12510074,  0.32338720,  0.49953167,  0.31673121,  0.10211691, -0.18959777,  0.08248388,  0.32802584,  0.38349350,  0.15661854, -0.30813425, -0.36281069, -0.14158148, -0.23780055,  0.36602060,  0.33302723,  0.01360850,  0.39664815,  0.19778483, -0.02031319, -0.18224932, -0.02340811,  0.28714313,  0.27986778,  0.49094832,  0.28813305,  0.17243639,  0.02652240,  0.42710309,  0.35603719,  0.24390195, -0.33672170, -0.43172319,  0.20448630, -0.33771977, -0.31760038, -0.47061845, -0.36485651,  0.21202984,  0.19864111,  0.21479723,  0.17098263,  0.17383412, -0.45547248, -0.15503399, -0.24721635,  0.35519697, -0.24832399,  0.29920229, -0.01360185, -0.23132271,  0.10616094,  0.29839064, -0.32847974, -0.07900287,  0.29278371, -0.13168268, -0.29621483,  0.19330212, -0.23605514, -0.45697131,  0.25384600},
								{  0.29193704, -0.49013870, -0.08135053, -0.07110763,  0.09356291, -0.19070984,  0.38014221,  0.16144258,  0.26036501, -0.44973120,  0.14349229,  0.12878460, -0.11603271,  0.13145116,  0.05484199, -0.26068744, -0.13492161,  0.14583125, -0.33396526, -0.49441606, -0.49012354,  0.13178993,  0.33758510,  0.30663775, -0.44113783,  0.13426596, -0.42794076, -0.38666002, -0.22869183, -0.47125179, -0.35284676, -0.03647442,  0.44232657, -0.03323745,  0.30451681, -0.19746618,  0.43289706,  0.43273619,  0.36779570, -0.45336385, -0.28801204,  0.48548351,  0.10493711,  0.27907925,  0.00920600,  0.41755720, -0.22784256,  0.39118280, -0.38878356,  0.02162234, -0.21472059, -0.38348484, -0.24575307, -0.30813674, -0.28677062, -0.17727557, -0.03811222,  0.06081673,  0.08769677,  0.48371192,  0.11856262, -0.01590212,  0.00392760, -0.21893602,  0.43825748,  0.29272079, -0.15618341, -0.38792783,  0.30683078, -0.28901198, -0.37477273,  0.44342546, -0.46894595, -0.42324598, -0.14237488, -0.25894131,  0.37136462,  0.38934721,  0.28196184,  0.32064368,  0.01488032, -0.40610350,  0.38402195, -0.14561807, -0.02774432, -0.06701087, -0.36592288, -0.00393925,  0.28425416,  0.04634874, -0.06497396, -0.43195282, -0.12304631,  0.29523097,  0.41745704,  0.09330284,  0.43582494, -0.04226094, -0.02084078, -0.40320429}};
	const double w_col[100][12] = {{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.04353233, -0.48149636,  0.32140716, -0.05529664,  0.11543235,  0.29193704},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.08972979,  0.39364953, -0.44210870, -0.14713187,  0.31316650, -0.49013870},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.48472607,  0.24678568, -0.05490357,  0.43181458, -0.03400566, -0.08135053},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.18127716, -0.12051898,  0.33179602,  0.00281288,  0.20947139, -0.07110763},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.34912702,  0.19789848, -0.12162700,  0.36001160,  0.35365513,  0.09356291},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.15802938, -0.21027410, -0.15880643,  0.03407902,  0.22711322, -0.19070984},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.19456724,  0.12131013,  0.29482108,  0.45684345,  0.02259035,  0.38014221},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.36348126, -0.48824331,  0.39389797, -0.30086193, -0.20127699,  0.16144258},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.01551175, -0.16604852, -0.06709340, -0.27405013,  0.07980687,  0.26036501},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.03890487,  0.06782871,  0.29421065, -0.44081741,  0.10286909, -0.44973120},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.49008259,  0.28886169, -0.06134147, -0.00168870, -0.28603667,  0.14349229},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.06007569,  0.43338011,  0.18333232, -0.28744014,  0.33923824,  0.12878460},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.04857517, -0.45610467, -0.47281488, -0.18731495, -0.48713743, -0.11603271},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.48364507, -0.30992541,  0.08691847, -0.44241891, -0.13243196,  0.13145116},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.34639364,  0.17564465,  0.19921333,  0.22750913, -0.02161562,  0.05484199},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.36560348, -0.26764963,  0.30487174,  0.40839754, -0.26810568, -0.26068744},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.32920719,  0.49429549, -0.06020914, -0.15995205, -0.18578269, -0.13492161},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.43423652, -0.23555083, -0.33969966,  0.37285526, -0.26211969,  0.14583125},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.06983395,  0.39032172,  0.23490821,  0.18732359, -0.15388803, -0.33396526},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.03923017, -0.04264562, -0.04931112, -0.08778094,  0.40160982, -0.49441606},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.09992648, -0.30121148,  0.12520102,  0.23336280, -0.12411452, -0.49012354},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.12080133,  0.23127726, -0.30610682,  0.40481233,  0.06920575,  0.13178993},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.12731479,  0.19908014, -0.10281605, -0.08637110,  0.15521295,  0.33758510},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.27640121, -0.01065452, -0.31409555,  0.20063541,  0.48270880,  0.30663775},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.06677280,  0.32300831,  0.17394863,  0.49944730,  0.46163641, -0.44113783},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.20085723,  0.46228826,  0.25051823,  0.23999305, -0.06812661,  0.13426596},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.37345081,  0.01340071,  0.23265065, -0.07777341,  0.46137000, -0.42794076},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.14334446, -0.00169540, -0.06555946,  0.06245842,  0.11662113, -0.38666002},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.22691184,  0.12623464,  0.03685169, -0.44049595, -0.41103824, -0.22869183},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.09717078, -0.33855125,  0.32947425,  0.45612241,  0.09554800, -0.47125179},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.33384592,  0.33315146,  0.33863970, -0.04838597,  0.45660138, -0.35284676},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.25267237, -0.14729801, -0.31213952, -0.00935564, -0.09072567, -0.03647442},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.25404007,  0.08735822,  0.00605345, -0.03522108,  0.04141893,  0.44232657},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00301449,  0.22197985, -0.19379145, -0.38783629, -0.05671004, -0.03323745},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.28385902,  0.48615781, -0.02665729,  0.40281883, -0.04894124,  0.30451681},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.03919383, -0.05469295, -0.41225539, -0.05651678, -0.13370015, -0.19746618},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.31620571,  0.47709235, -0.27809192,  0.20368367,  0.02206092,  0.43289706},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.45095317,  0.25533857,  0.39481276, -0.21385035, -0.24879945,  0.43273619},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.41892627,  0.35112240,  0.06204868, -0.18070370, -0.12510074,  0.36779570},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.02211176, -0.38293985,  0.26991848, -0.12494420,  0.32338720, -0.45336385},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.26570027,  0.43309842, -0.43687210, -0.23578234,  0.49953167, -0.28801204},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.36905518, -0.40458698, -0.48513566, -0.21180665,  0.31673121,  0.48548351},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.23678807,  0.25363453,  0.15964480, -0.28593714,  0.10211691,  0.10493711},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.18588997,  0.17734595,  0.37683002, -0.48710950, -0.18959777,  0.27907925},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.27284628,  0.01625200, -0.04179578,  0.20320334,  0.08248388,  0.00920600},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.13819322,  0.48656686,  0.00287580,  0.44770338,  0.32802584,  0.41755720},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.22180028,  0.15163982,  0.25402267,  0.16316201,  0.38349350, -0.22784256},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.03384502,  0.41376324, -0.27142329,  0.36204490,  0.15661854,  0.39118280},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.07780517,  0.16042740,  0.17365301,  0.45733018, -0.30813425, -0.38878356},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.30770858,  0.21568905, -0.24932722,  0.43386482, -0.36281069,  0.02162234},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.36413561,  0.03249823,  0.22578931, -0.10129695, -0.14158148, -0.21472059},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.18133515,  0.16582341, -0.36528203, -0.47750671, -0.23780055, -0.38348484},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.22397034, -0.13154185, -0.48711369,  0.38920608,  0.36602060, -0.24575307},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.06762331,  0.48048127,  0.29183160, -0.34740638,  0.33302723, -0.30813674},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.10810566, -0.32400436, -0.49797444,  0.29022400,  0.01360850, -0.28677062},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.35002832, -0.11562595, -0.18894144, -0.33146556,  0.39664815, -0.17727557},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.14120266, -0.48380252,  0.33685156,  0.30346219,  0.19778483, -0.03811222},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.37535098,  0.33525940, -0.16690493,  0.38070533, -0.02031319,  0.06081673},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.01520790,  0.10586579,  0.46670263,  0.32211740, -0.18224932,  0.08769677},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.04543906,  0.40494922, -0.21784115, -0.43496565, -0.02340811,  0.48371192},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.04176379, -0.49314221, -0.04866233, -0.30433795,  0.28714313,  0.11856262},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.16888921,  0.00407844,  0.06456859,  0.26719736,  0.27986778, -0.01590212},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.44251124,  0.27014853,  0.23740432,  0.36626227,  0.49094832,  0.00392760},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.28121888, -0.39451950, -0.35857415, -0.04303170,  0.28813305, -0.21893602},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.18656502, -0.26884118, -0.08393617, -0.20120121,  0.17243639,  0.43825748},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.01441084,  0.45222323, -0.26807916, -0.02134161,  0.02652240,  0.29272079},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.31330552,  0.42382979, -0.30100274,  0.17427164,  0.42710309, -0.15618341},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.06034632,  0.20102291,  0.10971499, -0.20011434,  0.35603719, -0.38792783},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.24157260, -0.45710187, -0.49411521,  0.07441797,  0.24390195,  0.30683078},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.43024707, -0.19005864, -0.23118289,  0.03645104, -0.33672170, -0.28901198},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.19336714,  0.22067988,  0.45440651, -0.36886161, -0.43172319, -0.37477273},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.21290102,  0.04899644,  0.44134842, -0.17013522,  0.20448630,  0.44342546},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.45620461, -0.30377117,  0.27619251,  0.11329572, -0.33771977, -0.46894595},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.44503079,  0.09984132, -0.10685401, -0.28463381, -0.31760038, -0.42324598},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.46845084, -0.34433202, -0.33704446, -0.18660263, -0.47061845, -0.14237488},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.18997021, -0.36521231, -0.27667369, -0.10345321, -0.36485651, -0.25894131},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.34451594,  0.37915348, -0.31301047,  0.49130492,  0.21202984,  0.37136462},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.41708979, -0.37672131, -0.48655462, -0.13030928,  0.19864111,  0.38934721},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.14986813, -0.41499939,  0.26880950,  0.46970170,  0.21479723,  0.28196184},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.04592416,  0.34805722,  0.30209766,  0.16830641,  0.17098263,  0.32064368},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.14198289,  0.43819943, -0.01233303, -0.40900964,  0.17383412,  0.01488032},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.13822138, -0.49977183, -0.16436706, -0.22490018, -0.45547248, -0.40610350},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.22860019,  0.45509863,  0.15635111,  0.24230513, -0.15503399,  0.38402195},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.40596513, -0.05005355,  0.36915243, -0.10838278, -0.24721635, -0.14561807},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.44181215,  0.04218740, -0.04427404,  0.36308689,  0.35519697, -0.02774432},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.27256419, -0.17211704,  0.39946879, -0.18626951, -0.24832399, -0.06701087},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.38647996,  0.26126076,  0.38376633, -0.04259374,  0.29920229, -0.36592288},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.24731074,  0.08488692,  0.02370359, -0.33658095, -0.01360185, -0.00393925},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.39702348, -0.34168408, -0.08635014,  0.06041045, -0.23132271,  0.28425416},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.43322986, -0.24062003, -0.29582861, -0.45079156,  0.10616094,  0.04634874},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.42487529,  0.12949929,  0.37830878,  0.14167443,  0.29839064, -0.06497396},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.43530740,  0.04480906,  0.33637560, -0.35467801, -0.32847974, -0.43195282},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.45171012, -0.11984800, -0.08720878, -0.09860870, -0.07900287, -0.12304631},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.04576349, -0.46143930,  0.06243201, -0.12768785,  0.29278371,  0.29523097},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.26456716, -0.12285103,  0.40030622, -0.31656795, -0.13168268,  0.41745704},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.10256807,  0.23155079,  0.18463883,  0.47850302, -0.29621483,  0.09330284},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.25045811, -0.37380327, -0.45693752, -0.12906066,  0.19330212,  0.43582494},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.27287548, -0.20272598, -0.32214564,  0.19079916, -0.23605514, -0.04226094},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.36872136,  0.22473389,  0.39951821, -0.32929869, -0.45697131, -0.02084078},
{  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000,  0.00000000, -0.00612992, -0.08245903, -0.20774295, -0.21033606,  0.25384600, -0.40320429}};
	double *w_vec = (double*)w_col;
    
	memcpy(&A[0], &dv0[0], 144U * sizeof(double));
	memcpy(&B[0], &dv1[0], 36U * sizeof(double));
		
	/*  objective matrices */
	memset(&Q[0], 0, 144U * sizeof(double));
	for (i = 0; i < 12; i++) {
	Q[i + 12 * i] = 1.0;
	}

	memset(&R[0], 0, 9U * sizeof(double));
	for (i = 0; i < 3; i++) {
	R[i + 3 * i] = 1.0;
	}

	/*  state and control limits */
	for (i = 0; i < 12; i++) {
	xmin[i] = -4.0;
	xmax[i] = 4.0;
	}

	for (i = 0; i < 3; i++) {
	umin[i] = -0.5;
	umax[i] = 0.5;
	}

	/*  initial state */
	memset(&x0[0], 0, 12U * sizeof(double));
	//memset(&x_temp[0], 0, 12U * sizeof(double));
	
	/*  set up initial state and input trajectories */
	memset(&X0[0], 0, 120U * sizeof(double));
	memset(&U0[0], 0, 30U * sizeof(double));

	memcpy(&Qf[0], &Q[0], 144U * sizeof(double));/*  final state cost */
	kappa = 0.01;	/*  barrier parameter */
	niters = 5.0;	/*  number of newton steps */
	quiet = false;
	
	/* outputs */	
	At = malloc(sizeof(double)*n*n);
    Bt = malloc(sizeof(double)*n*m);
    eyen = malloc(sizeof(double)*n*n);
    eyem = malloc(sizeof(double)*m*m); 
    z = malloc(sizeof(double)*nz);
    x = malloc(sizeof(double)*n);
    zmax = malloc(sizeof(double)*nz);
    zmin = malloc(sizeof(double)*nz);
    zmaxp = malloc(sizeof(double)*nz);
    zminp = malloc(sizeof(double)*nz);
   
    /* eyen, eyem */
    dptr = eyen;
    for (i = 0; i < n*n; i++)
    {
        *dptr = 0;
        dptr++;
    }
    dptr = dptr-n*n;
    for (i = 0; i < n; i++)
    {
        *dptr = 1;
        dptr = dptr+n+1;
    }

    dptr = eyem;
    for (i = 0; i < m*m; i++)
    {
        *dptr = 0;
        dptr++;
    }
    dptr = dptr-m*m;
    for (i = 0; i < m; i++)
    {
        *(dptr+i*m+i) = 1;
    }
    dptr = x; dptr1 = x0;
    for (i = 0; i < n; i++)
    {
        *dptr = *dptr1;
        dptr++; dptr1++;
    }
	// z
	dptr = z;
	for (i = 0; i < T; i++)
	{
		for (j = 0; j < m; j++)
		{
			*dptr = *(U0+i*m+j);
			dptr++;
		}
		for (j = 0; j < n; j++)
		{
			*dptr = *(X0+i*n+j);
			dptr++; 
		}
	}
	
	/* At, Bt */
    F77_CALL(dgemm)("t","n",&n,&n,&n,&fone,A,&n,eyen,&n,&fzero,At,&n);
    F77_CALL(dgemm)("n","t",&m,&n,&m,&fone,eyem,&m,B,&n,&fzero,Bt,&m);

    /* zmax, zmin */ 
    dptr1 = zmax;
    dptr2 = zmin;
    for (i = 0; i < T; i++)
    {
        for (j = 0; j < m; j++)
        {
            *dptr1 = *(umax+j);
            *dptr2 = *(umin+j);
            dptr1++; dptr2++;
        }
        for (j = 0; j < n; j++)
        {
            *dptr1 = *(xmax+j);
            *dptr2 = *(xmin+j);
            dptr1++; dptr2++;
        }
    }  

    /* zmaxp, zminp */
    for (i = 0; i < nz; i++) zminp[i] = zmin[i] + 0.01*(zmax[i]-zmin[i]);
    for (i = 0; i < nz; i++) zmaxp[i] = zmax[i] - 0.01*(zmax[i]-zmin[i]);

    /* project z */
    for (i = 0; i < nz; i++) z[i] = z[i] > zmaxp[i] ? zmaxp[i] : z[i];
    for (i = 0; i < nz; i++) z[i] = z[i] < zminp[i] ? zminp[i] : z[i];
    
	/* printmat(A, n ,n);
	printf("\n");
	printmat(B, n ,m);
	printf("\n");
	printmat(Q, n ,n);
	printf("\n");
	printmat(R, m ,m);
	printf("\n");
	printmat(Qf, n ,n); */
	
	const double xx[12] = { 0.0, -0.0, -0.0, -0.0, -0.0, -0.0,
	-0.0435, -0.4815, 0.3214, -0.0553, 0.1154, 0.2919 };
	memcpy(&x[0], &xx[0], n * sizeof(double));
	
	k=0;
	while (k < nsteps) {
		//printf("\n");
		//printmat(x, n, 1);
		t1 = clock();
		fmpcsolve(A,B,At,Bt,eyen,eyem,Q,R,Qf,zmax,zmin,x,z,T,n,m,nz,niters,kappa);
		t2 = clock();
		telapsed = (double)(t2-t1)/(CLOCKS_PER_SEC);

		dptr = z;
		for (i = 0; i < T; i++)
		{
			for (j = 0; j < m; j++)
			{
				*(U+i*m+j) = *dptr;
				dptr++;
			}
			for (j = 0; j < n; j++)
			{
				*(X+i*n+j) = *dptr;
				dptr++; 
			}
		}
		
		for (i = 0; i < m; i++) {
			u_[i] = U[i];
		}
		for (i = 0; i < n; i++) {	
			Xhist[i+n*k] = x[i];
		}
		for (i = 0; i < m; i++) {	
			Uhist[i+n*k] = u_[i];
		}
		/* Jhist left!!!*/
		
		for (i = 0; i < n; i++) {
			w_temp[i] = w_vec[i+k*n];
			//sprintf("%d \n", w_temp[i]);
		}
		
		printf("\n u_ ");
		printmat(u_, m ,1);
		
		F77_CALL(dgemv)("n", &n, &n, &fone, A, &n, x ,&ione, &fzero, x_temp, &ione);
		F77_CALL(dgemv)("n", &n, &m, &fone, B, &n, u_ ,&ione, &fone, w_temp, &ione);
		
		//printf("\n");
		//printmat(x_temp, n ,1);
		
		for (i = 0; i < n; i++) {
			x[i] = x_temp[i] + w_temp[i];
		}
		
		/* dptr = z;
		for (i = 0; i < n + m; i++) {
			dptr++;
		}
		
		for (i = 0; i < T; i++)
		{
			for (j = 0; j < m; j++)
			{
				if (i == T-1) {
					*(U+i*m+j) = 0;
					dptr++;
				}
				else {
					*(U+i*m+j) = *dptr;
					dptr++;
				}
			}
			for (j = 0; j < n; j++)
			{
				if (i == T-1) {
					*(X+i*n+j) = 0;
					dptr++; 
				}
				else {
					*(X+i*n+j) = *dptr;
					dptr++; 	
				}
			}
		} */
		
		dptr = z;
		for (i = 0; i < T; i++)
		{
			for (j = 0; j < m; j++)
			{
				if (i == T-1) {	//last coloumn
					*dptr = 0;
					dptr++;
				}
				else {
					*dptr = *(U+i*m+j+m);	//offset with m
					dptr++;
				}
			}
			for (j = 0; j < n; j++)
			{
				if (i == T-1) {	//last coloumn
					*dptr = 0;
					dptr++;
				}
				else {
					*dptr = *(X+i*n+j+n);	//offset with n
					dptr++;
				} 
			}
		}
			
		k++;
		//printf("%i \n", k);
	}

	printf("\n");
	printmat(x, n ,1);
	
	free(At); free(Bt); free(eyen); free(eyem);
    free(z); free(x); free(zmax); free(zmin);
    
    printf(" HERE\n");
    return 0;
}

void printmat(double *A, int m, int n)
{
    double *dptr;
    int j, i;
    dptr = A;
    for (j = 0; j < m; j++)
    {
        for (i = 0; i < n; i++)
        {
            printf("%5.4f\t", *(dptr+m*i+j));
        }
        printf("\n");
    }
    return;
}
    
void fmpcsolve(double *A, double *B, double *At, double *Bt, double *eyen,
         double *eyem, double *Q, double *R, double *Qf, double *zmax, double *zmin, 
         double *x, double *z0, int T, int n, int m, int nz, int niters, double kappa) 
{
    int maxiter = niters;
    int iiter, i, cont;
    double alpha = 0.01;
    double beta = 0.9;
    double tol = 0.1;
    double s;
    double resd, resp, res, newresd, newresp, newres;
    double *b, *z, *nu, *Ctnu;
    double *dnu, *dz;
    double *gf, *gp, *hp, *newgf, *newgp, *newhp;
    double *rd, *rp, *newrd, *newrp;
    double *dptr, *dptr1, *dptr2, *dptr3;
    double *newnu, *newz, *newCtnu;

    /* memory allocation */
    b = malloc(sizeof(double)*T*n);
    dnu = malloc(sizeof(double)*T*n);
    dz = malloc(sizeof(double)*nz);
    nu = malloc(sizeof(double)*T*n);
    Ctnu = malloc(sizeof(double)*nz);
    z = malloc(sizeof(double)*nz);
    gp = malloc(sizeof(double)*nz);
    hp = malloc(sizeof(double)*nz);
    gf = malloc(sizeof(double)*nz);
    rp = malloc(sizeof(double)*T*n);
    rd = malloc(sizeof(double)*nz);
    newnu = malloc(sizeof(double)*T*n);
    newz = malloc(sizeof(double)*nz);
    newCtnu = malloc(sizeof(double)*nz);
    newgf = malloc(sizeof(double)*nz);
    newhp = malloc(sizeof(double)*nz);
    newgp = malloc(sizeof(double)*nz);
    newrp = malloc(sizeof(double)*T*n);
    newrd = malloc(sizeof(double)*nz);

    for (i = 0; i < n*T; i++) nu[i] = 0;
    for (i = 0; i < n*T; i++) b[i] = 0;

    F77_CALL(dgemv)("n",&n,&n,&fone,A,&n,x,&ione,&fzero,b,&ione);
    dptr = z; dptr1 = z0;
    for (i = 0; i < nz; i++) 
    {
        *dptr = *dptr1;
        dptr++; dptr1++;
    }
    if (quiet == 0)
    {   
        printf("\n iteration \t step \t\t rd \t\t\t rp\n");
    }
    for (iiter = 0; iiter < maxiter; iiter++)
    {
        gfgphp(Q,R,Qf,zmax,zmin,z,T,n,m,nz,gf,gp,hp);
        rdrp(A,B,Q,R,Qf,z,nu,gf,gp,b,T,n,m,nz,kappa,rd,rp,Ctnu);
        resdresp(rd,rp,T,n,nz,&resd,&resp,&res);

        if (res < tol) break;

        dnudz(A,B,At,Bt,eyen,eyem,Q,R,Qf,hp,rd,rp,T,n,m,nz,kappa,dnu,dz); 

        s = 1; 
        /* feasibility search */
        while (1)
        {
            cont = 0;
            dptr = z; dptr1 = dz; dptr2 = zmax; dptr3 = zmin;
            for (i = 0; i < nz; i++)
            {
                if (*dptr+s*(*dptr1) >= *dptr2) cont = 1;
                if (*dptr+s*(*dptr1) <= *dptr3) cont = 1;
                dptr++; dptr1++; dptr2++; dptr3++;
            }
            if (cont == 1)
            {
                s = beta*s;
                continue;
            }
            else
                break;
        }

        dptr = newnu; dptr1 = nu; dptr2 = dnu;
        for (i = 0; i < T*n; i++)
        {
            *dptr = *dptr1+s*(*dptr2);
            dptr++; dptr1++; dptr2++;
        }
        dptr = newz; dptr1 = z; dptr2 = dz;
        for (i = 0; i < nz; i++)
        {
            *dptr = *dptr1+s*(*dptr2);
            dptr++; dptr1++; dptr2++;
        }

        /* insert backtracking line search */
        while (1)
        {
            gfgphp(Q,R,Qf,zmax,zmin,newz,T,n,m,nz,newgf,newgp,newhp);
            rdrp(A,B,Q,R,Qf,newz,newnu,newgf,newgp,b,T,n,m,nz,kappa,newrd,newrp,newCtnu);
            resdresp(newrd,newrp,T,n,nz,&newresd,&newresp,&newres);
            if (newres <= (1-alpha*s)*res) break;
            s = beta*s;
            dptr = newnu; dptr1 = nu; dptr2 = dnu;
            for (i = 0; i < T*n; i++)
            {
                *dptr = *dptr1+s*(*dptr2);
                dptr++; dptr1++; dptr2++;
            }
            dptr = newz; dptr1 = z; dptr2 = dz;
            for (i = 0; i < nz; i++)
            {
                *dptr = *dptr1+s*(*dptr2);
                dptr++; dptr1++; dptr2++;
            }
        }
        
        dptr = nu; dptr1 = newnu; 
        for (i = 0; i < T*n; i++)
        {
            *dptr = *dptr1;
            dptr++; dptr1++;
        }
        dptr = z; dptr1 = newz;
        for (i = 0; i < nz; i++)
        {
            *dptr = *dptr1;
            dptr++; dptr1++;
        }
        if (quiet == 0)
        {
            printf("    %d \t\t %5.4f \t %0.5e \t\t %0.5e\n",iiter,s,newresd,newresp);
        }
    }
    dptr = z0; dptr1 = z;
    for (i = 0; i < nz; i++)
    {
        *dptr = *dptr1;
        dptr++; dptr1++;
    }

    free(b); free(dnu); free(dz); free(nu); free(Ctnu);
    free(z); free(gp); free(hp); free(gf); free(rp); free(rd);
    free(newnu); free(newz); free(newCtnu); free(newgf); free(newhp);
    free(newgp); free(newrp); free(newrd);
    return;
}

/* computes the search directions dz and dnu */
void dnudz(double *A, double *B, double *At, double *Bt, double *eyen,
        double *eyem, double *Q, double *R, double *Qf, double *hp, double *rd, 
        double *rp, int T, int n, int m, int nz, double kappa, double *dnu, double *dz)
{
    int i,j,info,nT;
    double *dptr, *dptr1, *dptr2, *dptr3, *temp, *tempmatn, *tempmatm;
    double *PhiQ, *PhiR, *Yd, *Yud, *Ld, *Lld, *Ctdnu, *gam, *v, *be, *rdmCtdnu;
    double *PhiinvQAt, *PhiinvRBt, *PhiinvQeye, *PhiinvReye, *CPhiinvrd;
    nT = n*T;

    /* allocate memory */
    PhiQ = malloc(sizeof(double)*n*n*T);
    PhiR = malloc(sizeof(double)*m*m*T);
    PhiinvQAt = malloc(sizeof(double)*n*n*T);
    PhiinvRBt = malloc(sizeof(double)*m*n*T);
    PhiinvQeye = malloc(sizeof(double)*n*n*T);
    PhiinvReye = malloc(sizeof(double)*m*m*T);
    CPhiinvrd = malloc(sizeof(double)*n*T);
    Yd = malloc(sizeof(double)*n*n*T);
    Yud = malloc(sizeof(double)*n*n*(T-1));
    Ld = malloc(sizeof(double)*n*n*T);
    Lld = malloc(sizeof(double)*n*n*(T-1));
    gam = malloc(sizeof(double)*n*T);
    v = malloc(sizeof(double)*n*T);
    be = malloc(sizeof(double)*n*T);
    temp = malloc(sizeof(double)*n);
    tempmatn = malloc(sizeof(double)*n*n);
    tempmatm = malloc(sizeof(double)*m*m);
    Ctdnu = malloc(sizeof(double)*nz);
    rdmCtdnu = malloc(sizeof(double)*nz);

    /* form PhiQ and PhiR */
    for (i = 0; i < T-1; i++)
    {
        dptr = PhiQ+n*n*i; dptr1 = Q;
        for (j = 0; j < n*n; j++)
        {
            *dptr = 2*(*dptr1);
            dptr++; dptr1++;
        }
        dptr = PhiQ+n*n*i; dptr1 = hp+m*(i+1)+n*i;
        for (j = 0; j < n; j++)
        {
            *dptr = *dptr+kappa*(*dptr1);
            dptr = dptr+n+1; dptr1++;
        }
        dptr = PhiR+m*m*i; dptr1 = R;
        for (j = 0; j < m*m; j++)
        {
            *dptr = 2*(*dptr1);
            dptr++; dptr1++;
        }
        dptr = PhiR+m*m*i; dptr1 = hp+i*(n+m);
        for (j = 0; j < m; j++)
        {
            *dptr = *dptr+kappa*(*dptr1);
            dptr = dptr+m+1; dptr1++;
        }
    }
    
    dptr = PhiR+m*m*(T-1); dptr1 = R;
    for (j = 0; j < m*m; j++)
    {
        *dptr = 2*(*dptr1);
        dptr++; dptr1++;
    }
    dptr = PhiR+m*m*(T-1); dptr1 = hp+(T-1)*(n+m);
    for (j = 0; j < m; j++)
    {
        *dptr = *dptr+kappa*(*dptr1);
        dptr = dptr+m+1; dptr1++;
    }
    dptr = PhiQ+n*n*(T-1); dptr1 = Qf;
    for (j = 0; j < n*n; j++)
    {
        *dptr = 2*(*dptr1);
        dptr++; dptr1++;
    }
    dptr = PhiQ+n*n*(T-1); dptr1 = hp+m*T+n*(T-1);
    for (j = 0; j < n; j++)
    {
        *dptr = *dptr+kappa*(*dptr1);
        dptr = dptr+n+1; dptr1++;
    }

    /* compute PhiinvQAt, PhiinvRBt, PhiinvQeye, PhiinvReye */
    for (i = 0; i < T; i++)
    {
        dptr = PhiinvQAt+n*n*i; dptr1 = At;
        for (j = 0; j < n*n; j++)
        {
            *dptr = *dptr1;
            dptr++; dptr1++;
        }
        dptr = dptr-n*n; dptr1 = PhiQ+n*n*i;
        F77_CALL(dposv)("l",&n,&n,dptr1,&n,dptr,&n,&info);
        dptr = PhiinvQeye+n*n*i; dptr1 = eyen;
        for (j = 0; j < n*n; j++)
        {
            *dptr = *dptr1;
            dptr++; dptr1++;
        }
        dptr = dptr-n*n; dptr1 = PhiQ+n*n*i;
        F77_CALL(dtrtrs)("l","n","n",&n,&n,dptr1,&n,dptr,&n,&info);
        F77_CALL(dtrtrs)("l","t","n",&n,&n,dptr1,&n,dptr,&n,&info);
    }
    for (i = 0; i < T; i++)
    {
        dptr = PhiinvRBt+m*n*i; dptr1 = Bt;
        for (j = 0; j < n*m; j++)
        {
            *dptr = *dptr1;
            dptr++; dptr1++;
        }
        dptr = dptr-m*n; dptr1 = PhiR+m*m*i;
        F77_CALL(dposv)("l",&m,&n,dptr1,&m,dptr,&m,&info);
        dptr = PhiinvReye+m*m*i; dptr1 = eyem;
        for (j = 0; j < m*m; j++)
        {
            *dptr = *dptr1;
            dptr++; dptr1++;
        }
        dptr = dptr-m*m; dptr1 = PhiR+m*m*i;
        F77_CALL(dtrtrs)("l","n","n",&m,&m,dptr1,&m,dptr,&m,&info);
        F77_CALL(dtrtrs)("l","t","n",&m,&m,dptr1,&m,dptr,&m,&info);
    }
    
    /* form Yd and Yud */
    dptr = Yud; dptr1 = PhiinvQAt; 
    for (i = 0; i < n*n*(T-1); i++)
    {
        *dptr = -(*dptr1);
        dptr++; dptr1++;
    }
    dptr2 = Yd; dptr3 = PhiinvQeye;
    for (i = 0; i < n*n; i++)
    {
        *dptr2 = *dptr3;
        dptr2++; dptr3++;
    }
    dptr2 = dptr2-n*n;
    F77_CALL(dgemm)("n","n",&n,&n,&m,&fone,B,&n,PhiinvRBt,&m,&fone,dptr2,&n);
    for (i = 1; i < T; i++)
    {
        dptr = Yd+n*n*i; dptr1 = PhiinvQeye+n*n*i;
        for (j = 0; j < n*n; j++)
        {
            *dptr = *dptr1;
            dptr++; dptr1++;
        }
        dptr1 = PhiinvRBt+m*n*i; dptr = dptr-n*n;
        F77_CALL(dgemm)("n","n",&n,&n,&m,&fone,B,&n,dptr1,&m,&fone,dptr,&n); 
        dptr1 = PhiinvQAt+n*n*(i-1);
        F77_CALL(dgemm)("n","n",&n,&n,&n,&fone,A,&n,dptr1,&n,&fone,dptr,&n);
    }

    /* compute Lii */
    dptr = Ld; dptr1 = Yd; 
    for (i = 0; i < n*n; i++)
    {
        *dptr = *dptr1;
        dptr++; dptr1++; 
    }
    dptr = dptr-n*n; 
    F77_CALL(dposv)("l",&n,&ione,dptr,&n,temp,&n,&info);
    for (i = 1; i < T; i++)
    {
        dptr = Ld+n*n*(i-1); dptr1 = Yud+n*n*(i-1); dptr2 = Lld+n*n*(i-1);
        for (j = 0; j < n*n; j++)
        {
            *dptr2 = *dptr1;
            dptr2++; dptr1++;
        }
        dptr2 = dptr2-n*n;
        F77_CALL(dtrtrs)("l","n","n",&n,&n,dptr,&n,dptr2,&n,&info);
        dptr1 = tempmatn;
        for (j = 0; j < n*n; j++)
        {
            *dptr1 = *dptr2;
            dptr1++; dptr2++;
        }
        dptr1 = dptr1-n*n; dptr2 = dptr2-n*n;
        F77_CALL(dgemm)("t","n",&n,&n,&n,&fone,dptr1,&n,eyen,&n,&fzero,dptr2,&n);
        dptr = Ld+n*n*i; dptr1 = Yd+n*n*i;
        for (j = 0; j < n*n; j++)
        {
            *dptr = *dptr1;
            dptr++; dptr1++;
        }
        dptr = dptr-n*n;
        F77_CALL(dgemm)("n","t",&n,&n,&n,&fmone,dptr2,&n,dptr2,&n,&fone,dptr,&n);
        F77_CALL(dposv)("l",&n,&ione,dptr,&n,temp,&n,&info);
    }

    /* compute CPhiinvrd */
    dptr = CPhiinvrd; dptr1 = rd+m;
    for (i = 0; i < n; i++)
    {
        *dptr = *dptr1;
        dptr++; dptr1++;
    }
    dptr = dptr-n;
    F77_CALL(dtrsv)("l","n","n",&n,PhiQ,&n,dptr,&ione);
    F77_CALL(dtrsv)("l","t","n",&n,PhiQ,&n,dptr,&ione);
    dptr2 = temp; dptr1 = rd;
    for (i = 0; i < m; i++)
    {
        *dptr2 = *dptr1;
        dptr2++; dptr1++;
    }
    dptr2 = dptr2-m;
    F77_CALL(dtrsv)("l","n","n",&m,PhiR,&m,dptr2,&ione);
    F77_CALL(dtrsv)("l","t","n",&m,PhiR,&m,dptr2,&ione);
    F77_CALL(dgemv)("n",&n,&m,&fmone,B,&n,temp,&ione,&fone,dptr,&ione);
    
    for (i = 1; i < T; i++)
    {
        dptr = CPhiinvrd+n*i; dptr1 = rd+m+i*(n+m);
        for (j = 0; j < n; j++)
        {
            *dptr = *dptr1;
            dptr++; dptr1++;
        }
        dptr = dptr-n; dptr3 = PhiQ+n*n*i;
        F77_CALL(dtrsv)("l","n","n",&n,dptr3,&n,dptr,&ione);
        F77_CALL(dtrsv)("l","t","n",&n,dptr3,&n,dptr,&ione);
        dptr2 = temp; dptr1 = rd+i*(m+n);
        for (j = 0; j < m; j++)
        {
            *dptr2 = *dptr1;
            dptr2++; dptr1++;
        }
        dptr3 = PhiR+m*m*i; dptr2 = dptr2-m;
        F77_CALL(dtrsv)("l","n","n",&m,dptr3,&m,dptr2,&ione);
        F77_CALL(dtrsv)("l","t","n",&m,dptr3,&m,dptr2,&ione);
        F77_CALL(dgemv)("n",&n,&m,&fmone,B,&n,temp,&ione,&fone,dptr,&ione);
        dptr2 = temp; dptr1 = rd+(i-1)*(n+m)+m;
        for (j = 0; j < n; j++)
        {
            *dptr2 = *dptr1;
            dptr2++; dptr1++;
        }
        dptr3 = PhiQ+n*n*(i-1); dptr2 = dptr2-n;
        F77_CALL(dtrsv)("l","n","n",&n,dptr3,&n,dptr2,&ione);
        F77_CALL(dtrsv)("l","t","n",&n,dptr3,&n,dptr2,&ione);
        F77_CALL(dgemv)("n",&n,&n,&fmone,A,&n,temp,&ione,&fone,dptr,&ione);
    }

    /* form be */
    dptr = be; dptr1 = rp; dptr2 = CPhiinvrd;
    for (i = 0; i < n*T; i++)
    {
        *dptr = (*dptr2)-(*dptr1);
        dptr++; dptr1++; dptr2++;
    }

    /* solve for dnu */
    dptr = v; dptr1 = be;
    for (i = 0; i < n; i++)
    {
        *dptr = -(*dptr1);
        dptr++; dptr1++;
    }
    dptr = dptr-n;
    F77_CALL(dtrsv)("l","n","n",&n,Ld,&n,dptr,&ione);
    for (i = 1; i < T; i++)
    {
        dptr = v+i*n; dptr1 = v+(i-1)*n; dptr2 = be+i*n; 
        for (j = 0; j < n; j++)
        {
            *dptr = *dptr2;
            dptr++; dptr2++;
        }
        dptr = dptr-n; dptr3 = Lld+n*n*(i-1);
        F77_CALL(dgemv)("n",&n,&n,&fmone,dptr3,&n,dptr1,&ione,&fmone,dptr,&ione);
        dptr3 = Ld+n*n*i;
        F77_CALL(dtrsv)("l","n","n",&n,dptr3,&n,dptr,&ione);
    }
    dptr = dnu+n*(T-1); dptr1 = v+n*(T-1);
    for (i = 0; i < n; i++)
    {
        *dptr = *dptr1;
        dptr++; dptr1++;
    }
    dptr = dptr-n; dptr3 = Ld+n*n*(T-1);
    F77_CALL(dtrsv)("l","t","n",&n,dptr3,&n,dptr,&ione);
    for (i = T-1; i > 0; i--)
    {
        dptr = dnu+n*(i-1); dptr1 = dnu+n*i; dptr2 = v+n*(i-1); 
        for (j = 0; j < n; j++)
        {
            *dptr = *dptr2;
            dptr++; dptr2++;
        }
        dptr = dptr-n; dptr3 = Lld+n*n*(i-1);
        F77_CALL(dgemv)("t",&n,&n,&fmone,dptr3,&n,dptr1,&ione,&fone,dptr,&ione);
        dptr3 = Ld+n*n*(i-1);
        F77_CALL(dtrsv)("l","t","n",&n,dptr3,&n,dptr,&ione);
    }

    /* form Ctdnu */
    for (i = 0; i < T-1; i++)
    {
        dptr = Ctdnu+i*(n+m); dptr1 = dnu+i*n;
        F77_CALL(dgemv)("n",&m,&n,&fmone,Bt,&m,dptr1,&ione,&fzero,dptr,&ione);
        dptr = Ctdnu+i*(n+m)+m; dptr2 = dnu+(i+1)*n;
        for (j = 0; j < n; j++)
        {
            *dptr = *dptr1;
            dptr++; dptr1++;
        }
        dptr = dptr-n;
        F77_CALL(dgemv)("n",&n,&n,&fmone,At,&n,dptr2,&ione,&fone,dptr,&ione);
    }
    
    dptr = Ctdnu+(T-1)*(n+m); dptr1 = dnu+(T-1)*n;
    F77_CALL(dgemv)("n",&m,&n,&fmone,Bt,&m,dptr1,&ione,&fzero,dptr,&ione);
    dptr = dptr+m; 
    for (i = 0; i < n; i++)
    {
        *dptr = *dptr1;
        dptr++; dptr1++;
    }
    dptr = rdmCtdnu; dptr1 = Ctdnu; dptr2 = rd;
    for (i = 0; i < nz; i++)
    {
        *dptr = -(*dptr1)-(*dptr2);
        dptr++; dptr1++; dptr2++;
    }

    /* solve for dz */
    for (i = 0; i < T; i++)
    {
        dptr = dz+(i+1)*m+i*n; dptr1 = rdmCtdnu+(i+1)*m+i*n;
        dptr2 = PhiinvQeye+n*n*i;
        F77_CALL(dgemv)("n",&n,&n,&fone,dptr2,&n,dptr1,&ione,&fzero,dptr,&ione);
    }
    for (i = 0; i < T; i++)
    {
        dptr = dz+i*(m+n); dptr1 = rdmCtdnu+i*(m+n);
        dptr2 = PhiinvReye+m*m*i;
        F77_CALL(dgemv)("n",&m,&m,&fone,dptr2,&m,dptr1,&ione,&fzero,dptr,&ione);
    }
    free(PhiQ); free(PhiR); free(PhiinvQAt); free(PhiinvRBt); free(PhiinvQeye);
    free(PhiinvReye); free(CPhiinvrd); free(Yd); free(Yud); free(Ld); free(Lld);
    free(gam); free(v); free(be); free(temp); free(tempmatn); free(tempmatm); 
    free(Ctdnu); free(rdmCtdnu);
    return;
}

/* computes rd and rp */
void rdrp(double *A, double *B, double *Q, double *R, double *Qf, double *z, double *nu, 
        double *gf, double *gp, double *b, int T, int n, int m, int nz, 
        double kappa, double *rd, double *rp, double *Ctnu)
{
    int i, j;
    double *Cz;
    double *dptr, *dptr1, *dptr2;

    Cz = malloc(sizeof(double)*T*n);
    
    /* compute Cz */
    dptr = Cz; dptr1 = z+m;
    for (i = 0; i < n; i++)
    {
        *dptr = *dptr1;
        dptr++; dptr1++;
    }
    F77_CALL(dgemv)("n",&n,&m,&fmone,B,&n,z,&ione,&fone,Cz,&ione);
    for (i = 2; i <= T; i++)
    {
        dptr = Cz+(i-1)*n; dptr1 = z+m+(i-2)*(n+m); 
        dptr2 = z+m+(i-1)*(m+n);
        for (j = 0; j < n; j++)
        {
            *dptr = *dptr2;
            dptr++; dptr2++;
        }
        dptr = dptr-n; 
        F77_CALL(dgemv)("n",&n,&n,&fmone,A,&n,dptr1,&ione,&fone,dptr,&ione);
        dptr1 = dptr1+n;
        F77_CALL(dgemv)("n",&n,&m,&fmone,B,&n,dptr1,&ione,&fone,dptr,&ione);
    }
    /*
    dptr = Cz+(T-1)*n; dptr1 = z+m+(T-2)*(n+m);
    F77_CALL(dgemv)("n",&n,&n,&fmone,A,&n,dptr1,&ione,&fzero,dptr,&ione);
    dptr1 = dptr1+n;
    F77_CALL(dgemv)("n",&n,&m,&fmone,B,&n,dptr1,&ione,&fone,dptr,&ione);
    dptr1 = z+nz-n;
    for (i = 0; i < n; i++)
    {
        *dptr = *dptr+*dptr1;
        dptr++; dptr1++;
    }
    */

    /* compute Ctnu */
    dptr = Ctnu; dptr1 = Ctnu+m; dptr2 = nu;
    for (i = 1; i <= T-1; i++)
    {
        F77_CALL(dgemv)("t",&n,&m,&fmone,B,&n,dptr2,&ione,&fzero,dptr,&ione);
        dptr = dptr+n+m;
        for (j = 0; j < n; j++)
        {
            *dptr1 = *dptr2;
            dptr1++; dptr2++;
        }
        dptr1 = Ctnu+m+(i-1)*(n+m);
        F77_CALL(dgemv)("t",&n,&n,&fmone,A,&n,dptr2,&ione,&fone,dptr1,&ione);
        dptr1 = dptr1+n+m;
    }
    F77_CALL(dgemv)("t",&n,&m,&fmone,B,&n,dptr2,&ione,&fzero,dptr,&ione);
    dptr = Ctnu+nz-n; dptr1 = nu+(T-1)*n;
    for (i = 0; i < n; i++)
    {
        *dptr = *dptr1;
        dptr++; dptr1++;
    }

    dptr = rp; dptr1 = Cz; dptr2 = b;
    for (i = 0; i < n*T; i++)
    {
        *dptr = *dptr1-*dptr2;
        dptr++; dptr1++; dptr2++;
    }
    dptr = rd; dptr1 = Ctnu; dptr2 = gf;
    for (i = 0; i < nz; i++)
    {
        *dptr = *dptr1+*dptr2;
        dptr++; dptr1++; dptr2++;
    }
    F77_CALL(daxpy)(&nz,&kappa,gp,&ione,rd,&ione);
    free(Cz);
    return;
}

/* computes gf, gp and hp */
void gfgphp(double *Q, double *R, double *Qf, double *zmax, double *zmin, double *z,
        int T, int n, int m, int nz, double *gf, double *gp, double *hp)
{
    int i;
    double *dptr, *dptr1, *dptr2;
    double *gp1, *gp2;

    gp1 = malloc(sizeof(double)*nz);
    gp2 = malloc(sizeof(double)*nz);

    dptr = gp1; dptr1 = zmax; dptr2 = z;
    for (i = 0; i < nz; i++)
    {
        *dptr = 1.0/(*dptr1-*dptr2);
        dptr++; dptr1++; dptr2++;
    }
    dptr = gp2; dptr1 = zmin; dptr2 = z;
    for (i = 0; i < nz; i++)
    {
        *dptr = 1.0/(*dptr2-*dptr1);
        dptr++; dptr1++; dptr2++;
    }
    dptr = hp; dptr1 = gp1; dptr2 = gp2;
    for (i = 0; i < nz; i++)
    {
        *dptr = (*dptr1)*(*dptr1) + (*dptr2)*(*dptr2);
        dptr++; dptr1++; dptr2++;
    }
    dptr = gp; dptr1 = gp1; dptr2 = gp2;
    for (i = 0; i < nz; i++)
    {
        *dptr = *dptr1-*dptr2;
        dptr++; dptr1++; dptr2++;
    }
    
    dptr = gf; dptr1 = z; 
    for (i = 0; i < T-1; i++)
    {
        F77_CALL(dgemv)("n",&m,&m,&ftwo,R,&m,dptr1,&ione,&fzero,dptr,&ione);
        dptr = dptr+m; dptr1 = dptr1+m;
        F77_CALL(dgemv)("n",&n,&n,&ftwo,Q,&n,dptr1,&ione,&fzero,dptr,&ione);
        dptr = dptr+n; dptr1 = dptr1+n;
    }
    F77_CALL(dgemv)("n",&m,&m,&ftwo,R,&m,dptr1,&ione,&fzero,dptr,&ione);
    dptr = dptr+m; dptr1 = dptr1+m;
    F77_CALL(dgemv)("n",&n,&n,&ftwo,Qf,&n,dptr1,&ione,&fzero,dptr,&ione);

    free(gp1); free(gp2);
    return;
}

/* computes resd, resp, and res */
void resdresp(double *rd, double *rp, int T, int n, int nz, double *resd, 
        double *resp, double *res)
{
    int nnu = T*n;
    *resp = F77_CALL(dnrm2)(&nnu,rp,&ione);
    *resd = F77_CALL(dnrm2)(&nz,rd,&ione);
    *res = sqrt((*resp)*(*resp)+(*resd)*(*resd));
    return;
}
